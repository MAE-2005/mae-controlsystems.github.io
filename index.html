<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAE Academy - Process Control v5 (Animated)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       GLOBAL STYLES
       ========================================= */
    :root{
      --bg:#e2efff;
      --ink:#1a1a1a;
      --card:#fff;
      --muted:#666;
      --line:#eee;
      --line2:#e9ecef;
      --shadow: rgba(0,0,0,0.10);
      --shadowSoft: rgba(0,0,0,0.05);
      --blue:#007bff;
      --greenBg:#d4edda;
      --green:#155724;
      --redBg:#f8d7da;
      --red:#721c24;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      font-family:'DM Sans',sans-serif;
      background: var(--bg);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      color:var(--ink);
      overflow-x:hidden;
    }

    /* Subtle animated blobs */
    .blob{
      position: fixed;
      width: 520px; height: 520px;
      border-radius: 999px;
      filter: blur(0px);
      opacity: .35;
      z-index: 0;
      pointer-events: none;
      animation: float 10s ease-in-out infinite;
    }
    .blob.blob-a{
      left: -220px; top: -220px;
      background: rgba(0,0,0,0.06);
      animation-duration: 11s;
    }
    .blob.blob-b{
      right: -240px; bottom: -240px;
      background: rgba(0,123,255,0.14);
      animation-duration: 13s;
      animation-direction: reverse;
    }
    @keyframes float{
      0%,100% { transform: translate(0,0) scale(1); }
      50% { transform: translate(22px, 18px) scale(1.03); }
    }

    /* App wrapper */
    .app{
      width:100%;
      max-width:1200px;
      position:relative;
      z-index: 1;
    }

    /* Screen Management + Animations */
    .screen{
      display:none;
      width:100%;
      max-width:1200px;
      flex-direction:column;
      align-items:center;
      will-change: opacity, transform;
    }
    .active-screen{ display:flex !important; }

    /* enter/exit animations */
    .screen.enter{
      animation: screenIn .35s cubic-bezier(.2,.8,.2,1) both;
    }
    .screen.exit{
      animation: screenOut .22s ease both;
    }
    @keyframes screenIn{
      from{ opacity:0; transform: translateY(14px) scale(.99); filter: blur(1px); }
      to{ opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    @keyframes screenOut{
      from{ opacity:1; transform: translateY(0) scale(1); }
      to{ opacity:0; transform: translateY(-6px) scale(.99); }
    }

    /* Home & Menu UI */
    #home-screen, #sim-menu-screen{
      justify-content:center;
      align-items:center;
      gap:80px;
      flex-wrap:wrap;
      margin-top:50px;
    }

    .left-content{
      display:flex;
      flex-direction:column;
      gap:15px;
      z-index:10;
      animation: popIn .5s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .title-small{
      font-size: clamp(2.5rem, 4vw, 4rem);
      font-weight:500;
      margin:0;
      line-height:1;
      letter-spacing:-2px;
      font-family:'Inter',sans-serif;
    }
    .title-bold{
      font-size: clamp(3.1rem, 5vw, 5rem);
      font-weight:900;
      margin:0;
      line-height:1;
      letter-spacing:-2px;
      font-family:'Inter',sans-serif;
    }
    .subtitle{
      font-size:1.2rem;
      margin:10px 0 30px 0;
      font-weight:500;
      color:#222;
    }

    /* Buttons */
    .pill-btn{
      background:#fff;
      border:2px solid #000;
      border-radius:50px;
      padding:18px 40px;
      font-size:1.1rem;
      font-weight:700;
      cursor:pointer;
      width:380px;
      max-width: 92vw;
      text-align:left;
      transition: transform .14s ease, background .14s ease, box-shadow .14s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:15px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.10);
      user-select:none;
    }
    .pill-btn:hover{
      transform: translateY(-3px);
      background:#f8f9fa;
      box-shadow: 0 7px 0 rgba(0,0,0,0.10);
    }
    .pill-btn:active{
      transform: translateY(1px);
      box-shadow: 0 2px 0 rgba(0,0,0,0.10);
    }

    /* ID Card */
    .id-card{
      background:#fff;
      border:2px solid #000;
      border-radius:20px;
      width:350px;
      height:550px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      box-shadow: 15px 15px 0 var(--shadowSoft);
      padding:20px;
      transform-origin: center;
      animation: cardIn .6s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes cardIn{
      from{ opacity:0; transform: translateY(14px) rotate(-1deg) scale(.98); }
      to{ opacity:1; transform: translateY(0) rotate(0) scale(1); }
    }
    .card-title{
      font-size:3.5rem;
      font-weight:900;
      letter-spacing:5px;
      margin:10px 0;
      font-family:'Inter',sans-serif;
    }
    .card-name{
      font-size:1.2rem;
      font-weight:700;
      text-transform:uppercase;
      font-family:'Inter',sans-serif;
    }

    /* Back Button */
    button.back-btn{
      background:none;
      border:none;
      font-size:1.1rem;
      font-weight:bold;
      cursor:pointer;
      display:flex;
      align-items:center;
      color:#333;
      margin-bottom:10px;
      transition: transform .15s ease, color .15s ease;
    }
    button.back-btn:hover{
      color: var(--blue);
      transform: translateX(-2px);
    }

    /* =========================================
       SIMULATOR STYLES
       ========================================= */
    .sim-container{
      background:#fff;
      padding:25px;
      border-radius:12px;
      box-shadow: 0 4px 20px var(--shadow);
      width:1000px;
      max-width:100%;
      animation: popIn .45s cubic-bezier(.2,.8,.2,1) both;
    }

    .visuals-row{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    @media (max-width:900px){
      .visuals-row{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--line);
      border-radius:8px;
      padding:10px;
      background:#fff;
      position:relative;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .panel:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.07);
    }

    .panel-label{
      font-weight:700;
      color:#555;
      margin-bottom:10px;
      display:block;
      font-size:0.9rem;
    }

    canvas{
      width:100%;
      height:350px;
      cursor:crosshair;
      display:block;
    }
    #sPlaneCanvas{
      background:#fafafa;
      border-left:1px solid var(--line);
    }

    /* Controls Grid */
    .controls-area{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:20px;
      background:#f8f9fa;
      padding:20px;
      border-radius:8px;
      border:1px solid var(--line2);
    }
    @media (max-width:800px){
      .controls-area{ grid-template-columns: 1fr; }
    }

    .control-column{
      display:flex;
      flex-direction:column;
      gap:15px;
      animation: fadeUp .5s ease both;
    }
    .control-column:nth-child(1){ animation-delay:.02s; }
    .control-column:nth-child(2){ animation-delay:.06s; }
    .control-column:nth-child(3){ animation-delay:.10s; }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .control-header{
      font-weight:800;
      font-size:1rem;
      margin-bottom:5px;
      color:#222;
      border-bottom:2px solid #ddd;
      padding-bottom:5px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .control-group label{
      display:flex;
      justify-content:space-between;
      font-weight:600;
      font-size:0.9rem;
      margin-bottom:5px;
    }
    input[type="range"]{ width:100%; cursor:pointer; }
    select, .toggle-btn{
      width:100%;
      padding:8px;
      border-radius:6px;
      border:1px solid #ccc;
      font-family:'DM Sans',sans-serif;
      font-weight:bold;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    select:focus{
      outline:none;
      border-color: rgba(0,123,255,0.55);
      box-shadow: 0 0 0 4px rgba(0,123,255,0.12);
    }

    /* Buttons */
    button.btn-step{
      background:#000;
      color:#fff;
      border:none;
      padding:12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      width:100%;
      transition: transform .14s ease, filter .14s ease;
    }
    button.btn-step:hover{
      filter: brightness(0.9);
      transform: translateY(-1px);
    }
    button.btn-step:active{
      transform: translateY(1px);
    }

    /* Math & Status */
    .math-display{
      font-family: 'Courier New', monospace;
      font-weight:bold;
      font-size:0.8rem;
      color:#333;
      background: rgba(255,255,255,0.7);
      padding:8px;
      border-radius:6px;
      border:1px solid var(--line);
      min-height:20px;
      word-wrap:break-word;
      transition: box-shadow .15s ease;
    }
    .math-display.glow{
      box-shadow: 0 0 0 4px rgba(0,123,255,0.12);
    }

    .status-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:6px;
      font-weight:bold;
      font-size:0.85rem;
      margin-top:5px;
      width:100%;
      text-align:center;
      box-sizing:border-box;
      transform-origin:center;
    }
    .status-stable{ background: var(--greenBg); color: var(--green); }
    .status-unstable{ background: var(--redBg); color: var(--red); }

    .status-bounce{
      animation: badgePop .25s ease;
    }
    @keyframes badgePop{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.06); }
      100%{ transform: scale(1); }
    }

    /* Warning Overlay (animated) */
    .warning-overlay{
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.95);
      display:none;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      color:#d32f2f;
      font-weight:bold;
      z-index:10;
      border-radius:8px;
      text-align:center;
    }
    .warning-overlay.show{
      display:flex;
      animation: warnIn .25s ease both;
    }
    @keyframes warnIn{
      from{ opacity:0; transform: scale(.98); }
      to{ opacity:1; transform: scale(1); }
    }
    .warning-overlay .icon{
      animation: shake .7s ease-in-out infinite;
    }
    @keyframes shake{
      0%,100%{ transform: rotate(0deg); }
      25%{ transform: rotate(-4deg); }
      75%{ transform: rotate(4deg); }
    }

    /* Toggle Switch UI */
    .mode-toggle{
      display:flex;
      background:#e9ecef;
      border-radius:8px;
      padding:2px; /* FIXED typo (pading -> padding) */
      margin-bottom:10px;
    }
    .mode-btn{
      flex:1;
      padding:8px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:bold;
      font-size:0.85rem;
      color:#666;
      border-radius:6px;
      transition: background .15s ease, transform .15s ease, box-shadow .15s ease, color .15s ease;
    }
    .mode-btn:hover{ transform: translateY(-1px); }
    .mode-btn.active{
      background:#fff;
      color:#000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.10);
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="blob blob-a"></div>
  <div class="blob blob-b"></div>

  <div class="app">
    <!-- HOME -->
    <div id="home-screen" class="screen active-screen enter">
      <div class="left-content">
        <div>
          <h1 class="title-small">Welcome to</h1>
          <h1 class="title-bold">MAE Academy</h1>
          <p class="subtitle">Learn & Enjoy</p>
        </div>
        <button class="pill-btn" onclick="alert('Module under construction')">
          Academic Courses <span>&#8594;</span>
        </button>
        <button class="pill-btn" onclick="navigateTo('sim-menu-screen')">
          Practical Simulations <span>&#8594;</span>
        </button>
      </div>

      <div class="id-card">
        <div class="logo-box">
          <svg width="120" height="100" viewBox="0 0 100 80" aria-label="MAE Logo">
            <path d="M10,10 L30,60 L50,10 L70,60 L90,10 L80,70 L20,70 Z"
                  fill="none" stroke="black" stroke-width="6" stroke-linejoin="round" />
            <line x1="20" y1="78" x2="80" y2="78" stroke="black" stroke-width="6" />
          </svg>
        </div>
        <div class="card-title">MAE</div>
        <div class="card-name">MOHAMMAD ABU ELYAN</div>
      </div>
    </div>

    <!-- MENU -->
    <div id="sim-menu-screen" class="screen">
      <div style="width:100%; max-width:1200px;">
        <button class="back-btn" style="align-self:flex-start;" onclick="navigateTo('home-screen')">&#8592; Back</button>
      </div>

      <div class="left-content" style="align-items:center; margin-top:20px;">
        <h1 class="title-small" style="font-size:3rem;">Simulations</h1>
        <p class="subtitle">Select a module to begin</p>

        <button class="pill-btn" onclick="startSimulator()">
          Process Control System <span>&#9654;</span>
        </button>

        <button class="pill-btn" style="opacity:0.5; cursor:not-allowed;" disabled>
          Fluid Mechanics (Soon)
        </button>
      </div>
    </div>

    <!-- SIMULATOR -->
    <div id="simulator-app" class="screen">
      <div style="width:100%; max-width:1200px;">
        <button class="back-btn" style="align-self:flex-start;" onclick="navigateTo('sim-menu-screen')">&#8592; Back to Menu</button>
      </div>

      <div class="sim-container">
        <div class="visuals-row">
          <div class="panel">
            <span class="panel-label">Time Response</span>
            <canvas id="simCanvas"></canvas>

            <div id="sim-warning" class="warning-overlay">
              <div class="icon" style="font-size:2rem; margin-bottom:10px;">⚠️</div>
              <div>Unstable!</div>
              <div style="font-size:0.8rem; font-weight:normal; margin-top:5px;">System reset.</div>
            </div>
          </div>

          <div class="panel">
            <span class="panel-label">Root Locus (Poles)</span>
            <canvas id="sPlaneCanvas"></canvas>
          </div>
        </div>

        <div class="controls-area">
          <div class="control-column">
            <div class="control-header">1. System Plant</div>

            <div class="control-group">
              <label>System Order</label>
              <select id="sys-order" onchange="updateUI()">
                <option value="1">1st Order (Thermal)</option>
                <option value="2" selected>2nd Order (Spring-Mass)</option>
                <option value="3">3rd Order (Motor + Inductance)</option>
              </select>
            </div>

            <div class="control-group param-1st" style="display:none;">
              <label>Time Constant (&tau;): <span id="val-tau">1.0</span>s</label>
              <input type="range" id="inp-tau" min="0.5" max="5.0" step="0.1" value="1.0">
            </div>

            <div class="control-group param-2nd">
              <label>Natural Freq (&omega;<sub>n</sub>): <span id="val-wn">5.0</span></label>
              <input type="range" id="inp-wn" min="1" max="15" step="0.5" value="5.0">
            </div>

            <div class="control-group param-2nd">
              <label>Damping Ratio (&zeta;): <span id="val-zeta">0.5</span></label>
              <input type="range" id="inp-zeta" min="0" max="2.0" step="0.05" value="0.5">
            </div>

            <div class="control-group param-3rd" style="display:none;">
              <label>Lag Pole (p): <span id="val-p3">10.0</span></label>
              <input type="range" id="inp-p3" min="1" max="20" step="1" value="10.0">
              <div style="font-size:0.75rem; color:#666; margin-top:2px;">Adds pole at s = -p</div>
            </div>
          </div>

          <div class="control-column">
            <div class="control-header">2. Controller</div>

            <div class="mode-toggle">
              <button class="mode-btn active" id="mode-manual" onclick="setMode('manual')">Manual (PID)</button>
              <button class="mode-btn" id="mode-design" onclick="setMode('design')">Design (&zeta;, &omega;)</button>
            </div>

            <div id="ctrl-manual">
              <div class="control-group">
                <label>Kp: <span id="val-kp">5.0</span></label>
                <input type="range" id="inp-kp" min="0" max="100" step="0.5" value="5.0">
              </div>
              <div class="control-group">
                <label>Ki: <span id="val-ki">1.0</span></label>
                <input type="range" id="inp-ki" min="0" max="50" step="0.5" value="1.0">
              </div>
              <div class="control-group">
                <label>Kd: <span id="val-kd">2.0</span></label>
                <input type="range" id="inp-kd" min="0" max="50" step="0.1" value="2.0">
              </div>
            </div>

            <div id="ctrl-design" style="display:none;">
              <div style="font-size:0.8rem; color:var(--blue); margin-bottom:10px; font-weight:bold;">
                Auto-calculates PID for target response
              </div>
              <div class="control-group">
                <label>Target &omega;<sub>n</sub>: <span id="val-twn">6.0</span></label>
                <input type="range" id="inp-twn" min="1" max="20" step="0.5" value="6.0">
              </div>
              <div class="control-group">
                <label>Target &zeta;: <span id="val-tzeta">0.7</span></label>
                <input type="range" id="inp-tzeta" min="0.1" max="1.5" step="0.05" value="0.7">
              </div>
              <div style="margin-top:10px; padding:8px; background:#e3f2fd; border-radius:6px; font-size:0.8rem;">
                Result: Kp=<span id="res-kp">--</span> Kd=<span id="res-kd">--</span>
              </div>
            </div>

            <button class="btn-step" style="margin-top:10px;" onclick="triggerStep()">Trigger Step</button>
          </div>

          <div class="control-column">
            <div class="control-header">3. Analysis</div>

            <div style="font-size:0.85rem; color:#666;">Characteristic Equation:</div>
            <div id="math-char-eq" class="math-display">...</div>

            <div style="font-size:0.85rem; color:#666; margin-top:10px;">Closed-Loop Poles:</div>
            <div id="math-roots" class="math-display">...</div>

            <div id="status-badge" class="status-badge status-stable">Stable</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Screen transitions (animated) =========
    function navigateTo(id){
      const current = document.querySelector('.screen.active-screen');
      const next = document.getElementById(id);
      if(current === next) return;

      if(current){
        current.classList.remove('enter');
        current.classList.add('exit');
      }

      setTimeout(() => {
        document.querySelectorAll('.screen').forEach(s => {
          s.classList.remove('active-screen','enter','exit');
        });
        next.classList.add('active-screen','enter');

        // if arriving to simulator, ensure canvases are crisp
        if(id === 'simulator-app' && window.simLoaded) resizeCanvases();
      }, current ? 180 : 0);
    }

    function startSimulator(){
      navigateTo('simulator-app');
      if(!window.simLoaded){
        initSim();
        window.simLoaded = true;
      }
    }

    // ========= Core Globals =========
    let canvas, ctx, sCanvas, sCtx, dpr=1;
    let sys = { order: 2, tau: 1.0, wn: 5.0, zeta: 0.5, p3: 10.0 };
    let pid = { sp: 50, kp: 5.0, ki: 1.0, kd: 2.0 };
    let design = { wn: 6.0, zeta: 0.7 };
    let state = { pv: 0, vel: 0, acc: 0, integ: 0, lastErr: 0 };
    let history = [];
    const MAX_HISTORY = 600;
    let controlMode = 'manual'; // 'manual' or 'design'

    function initSim(){
      canvas = document.getElementById('simCanvas'); ctx = canvas.getContext('2d');
      sCanvas = document.getElementById('sPlaneCanvas'); sCtx = sCanvas.getContext('2d');

      bindInputs();
      updateUI();
      resizeCanvases();
      window.addEventListener('resize', resizeCanvases);

      requestAnimationFrame(loop);
    }

    // Crisp canvas (Retina-safe)
    function resizeCanvases(){
      dpr = window.devicePixelRatio || 1;
      const set = (c) => {
        const rect = c.getBoundingClientRect();
        c.width = Math.floor(rect.width * dpr);
        c.height = Math.floor(rect.height * dpr);
      };
      set(canvas);
      set(sCanvas);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      sCtx.setTransform(dpr,0,0,dpr,0,0);
      drawGraph();
      analyze();
    }

    function setMode(mode){
      controlMode = mode;
      document.getElementById('mode-manual').className = mode === 'manual' ? 'mode-btn active' : 'mode-btn';
      document.getElementById('mode-design').className = mode === 'design' ? 'mode-btn active' : 'mode-btn';
      document.getElementById('ctrl-manual').style.display = mode === 'manual' ? 'block' : 'none';
      document.getElementById('ctrl-design').style.display = mode === 'design' ? 'block' : 'none';
      if(mode === 'design'){ runAutoTune(); syncPidSliders(); }
      analyze();
    }

    function bindInputs(){
      const bind = (id, obj, key) => {
        const el = document.getElementById(id);
        el.addEventListener('input', e => {
          obj[key] = parseFloat(e.target.value);
          const labelId = id.replace('inp','val');
          const labelEl = document.getElementById(labelId);
          if(labelEl) labelEl.innerText = obj[key];

          if(controlMode === 'design') runAutoTune();
          analyze();
          glowMath();
        });
      };

      bind('inp-tau', sys, 'tau');
      bind('inp-wn', sys, 'wn');
      bind('inp-zeta', sys, 'zeta');
      bind('inp-p3', sys, 'p3');

      bind('inp-kp', pid, 'kp');
      bind('inp-ki', pid, 'ki');
      bind('inp-kd', pid, 'kd');

      bind('inp-twn', design, 'wn');
      bind('inp-tzeta', design, 'zeta');
    }

    function updateUI(){
      sys.order = parseInt(document.getElementById('sys-order').value);

      document.querySelectorAll('.param-1st').forEach(e => e.style.display = sys.order===1 ? 'block':'none');
      document.querySelectorAll('.param-2nd').forEach(e => e.style.display = (sys.order===2 || sys.order===3) ? 'block':'none');
      document.querySelectorAll('.param-3rd').forEach(e => e.style.display = sys.order===3 ? 'block':'none');

      resetSim();
      if(controlMode === 'design'){ runAutoTune(); syncPidSliders(); }
      analyze();
      glowMath();
    }

    function runAutoTune(){
      if(sys.order === 2){
        const ws2 = sys.wn * sys.wn;
        const target_w2 = design.wn * design.wn;
        const target_mid = 2 * design.zeta * design.wn;

        const req_Kp = (target_w2 / ws2) - 1;
        const req_Kd = (target_mid - (2*sys.zeta*sys.wn)) / ws2;

        pid.kp = Math.max(0, req_Kp);
        pid.kd = Math.max(0, req_Kd);
        pid.ki = 0.5;

        document.getElementById('res-kp').innerText = pid.kp.toFixed(2);
        document.getElementById('res-kd').innerText = pid.kd.toFixed(2);
      } else {
        document.getElementById('res-kp').innerText = "N/A";
        document.getElementById('res-kd').innerText = "N/A";
      }
    }

    // Keep sliders + values synced when autotune changes pid
    function syncPidSliders(){
      const set = (id, val) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.value = val;
        const label = document.getElementById(id.replace('inp','val'));
        if(label) label.innerText = (+val).toFixed(1);
      };
      set('inp-kp', pid.kp);
      set('inp-ki', pid.ki);
      set('inp-kd', pid.kd);
    }

    function resetSim(){
      state = { pv: 0, vel: 0, acc: 0, integ: 0, lastErr: 0 };
      history = [];
      hideWarning();
    }

    function triggerStep(){
      pid.sp = (pid.sp === 50) ? 80 : 50;
      glowMath();
    }

    // ========= Physics =========
    function updatePhysics(){
      const SUB = 20;
      const DT = 0.02 / SUB;

      for(let i=0; i<SUB; i++){
        const err = pid.sp - state.pv;
        state.integ += err * DT;
        const u = (pid.kp * err) + (pid.ki * state.integ) + (pid.kd * (err - state.lastErr)/DT);

        if(Number.isNaN(u) || Math.abs(u) > 1e6){ handleCrash(); return; }

        if(sys.order === 1){
          state.pv += ((u - state.pv) / sys.tau) * DT;
        } else if(sys.order === 2){
          const w2 = sys.wn * sys.wn;
          const force = (w2*u) - (2*sys.zeta*sys.wn*state.vel) - (w2*state.pv);
          state.vel += force * DT;
          state.pv += state.vel * DT;
        } else if(sys.order === 3){
          const w2 = sys.wn * sys.wn;
          const force = (w2*u) - (2*sys.zeta*sys.wn*state.vel) - (w2*state.acc);
          state.vel += force * DT;
          state.acc += state.vel * DT;
          const y_dot = sys.p3 * (state.acc - state.pv);
          state.pv += y_dot * DT;
        }

        state.lastErr = err;
        if(Math.abs(state.pv) > 1e4){ handleCrash(); return; }
      }

      history.push({ sp: pid.sp, pv: state.pv });
      if(history.length > MAX_HISTORY) history.shift();
    }

    function handleCrash(){
      showWarning();
      setTimeout(() => resetSim(), 1500);
    }

    function showWarning(){
      document.getElementById('sim-warning').classList.add('show');
    }
    function hideWarning(){
      document.getElementById('sim-warning').classList.remove('show');
    }

    // ========= Analysis =========
    function analyze(){
      let roots = [];
      let eqHTML = "";

      if(sys.order === 1){
        const A = sys.tau + pid.kd;
        const B = 1 + pid.kp;
        const C = pid.ki;
        eqHTML = `${A.toFixed(1)}s² + ${B.toFixed(1)}s + ${C.toFixed(1)} = 0`;
        roots = solveQuad(A, B, C);
      } else if(sys.order === 2){
        const w2 = sys.wn*sys.wn;
        const B = 2*sys.zeta*sys.wn + w2*pid.kd;
        const C = w2 + w2*pid.kp;
        const D = w2*pid.ki;
        eqHTML = `s³ + ${B.toFixed(1)}s² + ${C.toFixed(1)}s + ${D.toFixed(1)} = 0`;
        roots = solveCubic(B, C, D);
      } else {
        eqHTML = "Order 4 (Analysis Approx)";
        const imag = sys.wn * Math.sqrt(Math.abs(1 - sys.zeta*sys.zeta));
        roots = [
          {re: -sys.p3, im: 0},
          {re: -sys.zeta*sys.wn, im: imag},
          {re: -sys.zeta*sys.wn, im: -imag}
        ];
      }

      document.getElementById('math-char-eq').innerText = eqHTML;

      let stable = true;
      let txt = "";
      roots.forEach(r => {
        if(r.re > 0.001) stable = false;
        if(Math.abs(r.im) < 1e-6){
          txt += `s = ${r.re.toFixed(1)}<br>`;
        } else {
          txt += `s = ${r.re.toFixed(1)} ${r.im > 0 ? '+ ' : '- '}j${Math.abs(r.im).toFixed(1)}<br>`;
        }
      });
      document.getElementById('math-roots').innerHTML = txt;

      const badge = document.getElementById('status-badge');
      const wasStable = badge.classList.contains('status-stable');
      badge.innerText = stable ? "Stable" : "Unstable";
      badge.className = "status-badge " + (stable ? "status-stable" : "status-unstable");
      if(wasStable !== stable){
        badge.classList.add('status-bounce');
        setTimeout(() => badge.classList.remove('status-bounce'), 260);
      }

      drawSPlane(roots);
    }

    function glowMath(){
      const a = document.getElementById('math-char-eq');
      const b = document.getElementById('math-roots');
      a.classList.add('glow');
      b.classList.add('glow');
      clearTimeout(glowMath._t);
      glowMath._t = setTimeout(() => {
        a.classList.remove('glow');
        b.classList.remove('glow');
      }, 180);
    }

    // ========= Math Helpers =========
    function solveQuad(a, b, c){
      if(Math.abs(a) < 1e-5) return [{re: -c/b, im: 0}];
      const d = b*b - 4*a*c;
      if(d >= 0){
        return [
          {re: (-b + Math.sqrt(d)) / (2*a), im: 0},
          {re: (-b - Math.sqrt(d)) / (2*a), im: 0}
        ];
      }
      return [
        {re: -b/(2*a), im: Math.sqrt(-d)/(2*a)},
        {re: -b/(2*a), im: -Math.sqrt(-d)/(2*a)}
      ];
    }

    function solveCubic(a, b, c){
      const p = b - a*a/3;
      const q = 2*a*a*a/27 - a*b/3 + c;
      const d = q*q/4 + p*p*p/27;
      let roots = [];

      if(d > 0){
        const u = Math.cbrt(-q/2 + Math.sqrt(d));
        const v = Math.cbrt(-q/2 - Math.sqrt(d));
        roots.push({re: u+v - a/3, im: 0});
        roots.push({re: -(u+v)/2 - a/3, im: (u-v)*Math.sqrt(3)/2});
        roots.push({re: -(u+v)/2 - a/3, im: -(u-v)*Math.sqrt(3)/2});
      } else {
        const k = 2 * Math.sqrt(-p/3);
        // safer acos argument clamp
        const arg = Math.max(-1, Math.min(1, (3*q)/(2*p*k)));
        const t = Math.acos(arg);
        roots.push({re: k*Math.cos(t/3) - a/3, im: 0});
        roots.push({re: k*Math.cos((t+2*Math.PI)/3) - a/3, im: 0});
        roots.push({re: k*Math.cos((t+4*Math.PI)/3) - a/3, im: 0});
      }
      return roots;
    }

    // ========= Drawing =========
    function loop(){
      if(document.getElementById('simulator-app').classList.contains('active-screen')){
        updatePhysics();
        drawGraph();
      }
      requestAnimationFrame(loop);
    }

    function drawGraph(){
      if(!canvas) return;

      const rect = canvas.getBoundingClientRect();
      const W = rect.width;
      const H = rect.height;

      ctx.clearRect(0,0,W,H);

      // Grid
      ctx.strokeStyle="#eee";
      ctx.fillStyle="#888";
      ctx.font="10px Arial";

      [0,25,50,75,100,125].forEach(v => {
        let y = H - ((v+20)/160)*H;
        ctx.beginPath(); ctx.moveTo(30,y); ctx.lineTo(W,y); ctx.stroke();
        ctx.fillText(v, 5, y+3);
      });

      if(history.length < 2) return;

      // SP
      ctx.beginPath();
      ctx.strokeStyle="#bbb";
      ctx.setLineDash([5,5]);
      ctx.lineWidth=2;
      history.forEach((h,i) => {
        let x = (i/MAX_HISTORY)*W;
        let y = H - ((h.sp+20)/160)*H;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });
      ctx.stroke();

      // PV
      ctx.beginPath();
      ctx.strokeStyle="#007bff";
      ctx.setLineDash([]);
      ctx.lineWidth=3;
      history.forEach((h,i) => {
        let x = (i/MAX_HISTORY)*W;
        let y = H - ((h.pv+20)/160)*H;
        y = Math.max(-500, Math.min(800, y));
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function drawSPlane(roots){
      if(!sCanvas) return;

      const rect = sCanvas.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      sCtx.clearRect(0,0,w,h);
      const cx = w/2, cy = h/2, sc = 10;

      sCtx.strokeStyle="#ccc";
      sCtx.beginPath();
      sCtx.moveTo(cx,0); sCtx.lineTo(cx,h);
      sCtx.moveTo(0,cy); sCtx.lineTo(w,cy);
      sCtx.stroke();

      roots.forEach(r => {
        const x = cx + r.re*sc;
        const y = cy - r.im*sc;
        if(x>-50 && x<w+50 && y>-50 && y<h+50){
          sCtx.strokeStyle="red";
          sCtx.lineWidth=2;
          sCtx.beginPath();
          sCtx.moveTo(x-4,y-4); sCtx.lineTo(x+4,y+4);
          sCtx.moveTo(x+4,y-4); sCtx.lineTo(x-4,y+4);
          sCtx.stroke();
        }
      });
    }
  </script>
</body>
</html>
